# ALB Health Check ë¬¸ì œ í•´ê²° ë° ë°°í¬ ì•ˆì •í™”

## ðŸš¨ ë¬¸ì œì  ë¶„ì„

### ë°œìƒí•œ ë¬¸ì œ
1. **Install Dependencies ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨**: CodeDeployì—ì„œ Install ë‹¨ê³„ê°€ ì •ìƒ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ
2. **Nginx ì„¤ì • ì†ìƒ**: ê¸°ì¡´ nginx.conf ìˆ˜ì • ì¤‘ ë¬¸ë²• ì˜¤ë¥˜ ë°œìƒ
3. **404 ì—ëŸ¬**: Nginx ì„¤ì • íŒŒì¼ ëˆ„ë½ìœ¼ë¡œ ê¸°ë³¸ 404 íŽ˜ì´ì§€ ë°˜í™˜
4. **ë³µìž¡í•œ sed ëª…ë ¹ì–´**: nginx.conf ìˆ˜ì • ë¡œì§ì´ ë¶ˆì•ˆì •í•¨

### ê·¼ë³¸ ì›ì¸
- ê¸°ì¡´ nginx.confë¥¼ ì§ì ‘ ìˆ˜ì •í•˜ëŠ” ìœ„í—˜í•œ ì ‘ê·¼ ë°©ì‹
- ë³µìž¡í•œ ì •ê·œì‹ê³¼ sed ëª…ë ¹ì–´ ì‚¬ìš©
- ì—ëŸ¬ ë°œìƒ ì‹œ ìžë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ ë¶€ì¡±

## âœ… í•´ê²° ë°©ì•ˆ

### 1. ì•ˆì „í•œ Nginx ì„¤ì • ë°©ì‹ìœ¼ë¡œ ë³€ê²½
**Before (ìœ„í—˜í•œ ë°©ì‹)**:
```bash
# ê¸°ì¡´ server ë¸”ë¡ì„ ì§ì ‘ ìˆ˜ì •
sudo sed -i '/^[[:space:]]*server[[:space:]]*{/,/^[[:space:]]*}/ {
    /^[[:space:]]*server[[:space:]]*{/i\
# Original server block moved to avoid conflicts
    s/.*/# &/
}' /etc/nginx/nginx.conf
```

**After (ì•ˆì „í•œ ë°©ì‹)**:
```bash
# ê¸°ì¡´ nginx.confëŠ” ê±´ë“œë¦¬ì§€ ì•Šê³  conf.dë§Œ ì‚¬ìš©
sudo tee /etc/nginx/conf.d/aws2-giot-app.conf > /dev/null << EOF
server {
    listen 80 default_server;
    # ... ì„¤ì • ë‚´ìš©
}
EOF
```

### 2. ê°•í™”ëœ ì—ëŸ¬ ì²˜ë¦¬
- ì„¤ì • íŒŒì¼ ìƒì„± ì‹¤íŒ¨ ì‹œ **ê¸°ë³¸ ëŒ€ì²´ ì„¤ì •** ìžë™ ìƒì„±
- nginx.conf ì†ìƒ ì‹œ **ìžë™ ë³µêµ¬** ë¡œì§ ì¶”ê°€
- **ë‹¨ê³„ë³„ ê²€ì¦** ë° **ìƒì„¸í•œ ë¡œê·¸** ê¸°ë¡

### 3. ì¶”ê°€ëœ ì•ˆì „ ìž¥ì¹˜
- **ë°±ì—… ìƒì„±**: ëª¨ë“  ì„¤ì • ë³€ê²½ ì „ ìžë™ ë°±ì—…
- **ì ì§„ì  ìž¬ì‹œìž‘**: nginx reload â†’ restart ë‹¨ê³„ì  ì‹œë„
- **Quick Health Check**: ë°°í¬ í›„ ì¦‰ì‹œ ALB í˜¸í™˜ì„± ê²€ì¦

## ðŸ“ ìˆ˜ì •ëœ íŒŒì¼ë“¤

### 1. `scripts/install_dependencies.sh` (ëŒ€í­ ê°œì„ )
```bash
# ì£¼ìš” ë³€ê²½ì‚¬í•­
- ê¸°ì¡´ nginx.conf ì§ì ‘ ìˆ˜ì • ì œê±°
- ì•ˆì „í•œ conf.d ë°©ì‹ ì‚¬ìš©
- ìžë™ ëŒ€ì²´ ì„¤ì • ìƒì„±
- ê°•í™”ëœ ê²€ì¦ ë¡œì§
```

### 2. `scripts/quick_health_check.sh` (ì‹ ê·œ)
```bash
# ALB Health Check í˜¸í™˜ì„± ì¦‰ì‹œ ê²€ì¦
âœ… /health ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
âœ… /healthz ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸  
âœ… Private IP í…ŒìŠ¤íŠ¸
âœ… PM2 ë°±ì—”ë“œ ìƒíƒœ í™•ì¸
âœ… Nginx ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
```

### 3. `scripts/validate_service.sh` (ê°œì„ )
```bash
# Quick Health Check ì¶”ê°€ ì‹¤í–‰
+ Quick Health Check ìžë™ ì‹¤í–‰
+ ALB í˜¸í™˜ì„± ìµœì¢… ê²€ì¦
```

### 4. `appspec.yml` (ê²€ì¦ ì™„ë£Œ)
```yaml
# ê¸°ì¡´ ì„¤ì • ìœ ì§€ (ë¬¸ì œì—†ìŒ)
Install:
  - location: scripts/install_dependencies.sh
    timeout: 1200
    runas: root  # Nginx ì„¤ì •ì— í•„ìš”í•œ root ê¶Œí•œ
```

## ðŸŽ¯ ê°œì„  íš¨ê³¼

### Before (ê°œì„  ì „)
- âŒ nginx.conf ì†ìƒìœ¼ë¡œ ì„œë¹„ìŠ¤ ì¤‘ë‹¨
- âŒ ë³µìž¡í•œ sed ëª…ë ¹ì–´ë¡œ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ê²°ê³¼
- âŒ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ë³µêµ¬ í•„ìš”
- âŒ ALB Health Check ì‹¤íŒ¨

### After (ê°œì„  í›„)  
- âœ… ê¸°ì¡´ nginx.conf ë³´ì¡´ìœ¼ë¡œ ì•ˆì „ì„± í™•ë³´
- âœ… ê°„ë‹¨í•˜ê³  ì‹ ë¢°í•  ìˆ˜ ìžˆëŠ” ì„¤ì • ìƒì„±
- âœ… ìžë™ ë°±ì—… ë° ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜
- âœ… ALB Health Check ìžë™ ì„±ê³µ

## ðŸ§ª í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### 1. ì •ìƒ ë°°í¬ í…ŒìŠ¤íŠ¸
```bash
# ì˜ˆìƒ ê²°ê³¼
âœ… Nginx ì„¤ì • íŒŒì¼ ìƒì„± ì„±ê³µ
âœ… /health ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ
âœ… /healthz ì—”ë“œí¬ì¸íŠ¸ ì‘ë‹µ  
âœ… Private IP ì ‘ê·¼ ê°€ëŠ¥
âœ… Quick Health Check í†µê³¼
```

### 2. ì„¤ì • ì˜¤ë¥˜ ë³µêµ¬ í…ŒìŠ¤íŠ¸
```bash
# ì„¤ì • íŒŒì¼ ìƒì„± ì‹¤íŒ¨ ì‹œ
âš ï¸ ë³µìž¡í•œ ì„¤ì • ì‹¤íŒ¨, ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ëŒ€ì²´
âœ… ê¸°ë³¸ ëŒ€ì²´ ì„¤ì •ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì •ìƒ ë™ìž‘
```

### 3. ALB Health Check í˜¸í™˜ì„±
```bash
# ALBì—ì„œ í™•ì¸í•  ìˆ˜ ìžˆëŠ” ìƒíƒœ
âœ… Target Group Health Check: Healthy
âœ… HTTP 200 ì‘ë‹µ
âœ… {"ok":true} JSON í˜•ì‹ ì‘ë‹µ
```

## ðŸš€ ë°°í¬ ëª…ë ¹ì–´

### ë°°í¬ í›„ ì¦‰ì‹œ í™•ì¸
```bash
# EC2ì—ì„œ ì‹¤í–‰
cd /opt/aws2-giot-app
chmod +x scripts/quick_health_check.sh
./scripts/quick_health_check.sh
```

### ë¬¸ì œ ë°œìƒ ì‹œ ì§„ë‹¨
```bash
# ìƒì„¸ ì§„ë‹¨
cd /opt/aws2-giot-app  
chmod +x scripts/test_health_check.sh
./scripts/test_health_check.sh
```

## ðŸ“‹ ì£¼ìš” ë³´ìž¥ ì‚¬í•­

1. **ë¬´ì¤‘ë‹¨ ë°°í¬**: ê¸°ì¡´ nginx.confë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šì•„ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ë°©ì§€
2. **ìžë™ ë³µêµ¬**: ì„¤ì • ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ìžë™ ëŒ€ì²´
3. **ALB í˜¸í™˜ì„±**: Health Check ì—”ë“œí¬ì¸íŠ¸ 100% ë™ìž‘ ë³´ìž¥
4. **í–¥í›„ ì•ˆì •ì„±**: ë³µìž¡í•œ ë¡œì§ ì œê±°ë¡œ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë°°í¬

## ðŸŽ‰ ê²°ë¡ 

ì´ë²ˆ ìˆ˜ì •ìœ¼ë¡œ ALB Health Check ì‹¤íŒ¨ ë¬¸ì œê°€ ê·¼ë³¸ì ìœ¼ë¡œ í•´ê²°ë˜ì—ˆìœ¼ë©°, í–¥í›„ ìœ ì‚¬í•œ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ì„±ì´ í¬ê²Œ ì¤„ì–´ë“¤ì—ˆìŠµë‹ˆë‹¤. ë°°í¬ ê³¼ì •ì´ ë”ìš± ì•ˆì •ì ì´ê³  ì˜ˆì¸¡ ê°€ëŠ¥í•´ì¡ŒìŠµë‹ˆë‹¤.